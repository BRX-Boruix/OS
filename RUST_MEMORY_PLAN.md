# Rust内存管理器渐进式实现计划

## 阶段0: 基础框架（当前状态）
- ✅ 项目结构已创建
- ✅ 所有模块文件存在
- ⚠️ FFI接口为空实现

## 阶段1: 最小可用FFI - 只返回NULL/假数据
**目标**: 系统能编译和启动，但Rust不做任何实际工作
**实现**:
- `rust_memory_init()` - 直接返回0（成功）
- `rust_kmalloc()` - 返回NULL（触发fallback）
- `rust_kfree()` - 空函数
- 其他函数返回安全的默认值

**测试**: 系统应该能启动并使用简单分配器

## 阶段2: 物理内存分配器
**目标**: 实现物理页面分配
**实现**:
- 完整实现 `physical.rs`
- 实现 `rust_memory_init()` - 只初始化物理分配器
- 实现 `rust_alloc_page()` / `rust_free_page()`
- **不**初始化堆和页表

**测试**: 
- 调用 `alloc_page()` 应该返回有效地址
- 多次分配应该返回不同地址
- 释放后再分配应该能重用

## 阶段3: 页表管理器（只读）
**目标**: 能查询现有页表，不修改
**实现**:
- 实现 `paging.rs` 的 `init()` - 获取当前CR3
- 实现 `rust_virt_to_phys()` - 查询现有页表
- **不**创建新页表，不映射新页面

**测试**:
- 查询内核地址应该返回正确的物理地址
- 查询未映射地址应该返回0

## 阶段4: 页表管理器（读写）
**目标**: 能映射和取消映射页面
**实现**:
- 实现 `rust_map_page()` - 修改现有页表
- 实现 `rust_unmap_page()` - 清除页表项
- 使用物理分配器分配页表页面

**测试**:
- 映射新页面
- 验证映射成功（virt_to_phys）
- 取消映射
- 验证已清除

## 阶段5: 静态堆分配器
**目标**: 在固定内存区域实现堆
**实现**:
- 修改 `heap.rs` - 不使用页表映射
- 使用一个静态数组作为堆（比如16MB）
- 实现 `rust_kmalloc()` / `rust_kfree()`
- **不**动态扩展堆

**测试**:
- 分配小块内存
- 分配大块内存
- 释放和重新分配
- 检查内存统计

## 阶段6: 动态堆（使用页表）
**目标**: 堆可以动态映射物理页面
**实现**:
- 修改堆初始化 - 映射物理页面到堆区域
- 实现堆扩展 - 按需分配更多页面
- 完整的堆管理（分割、合并、统计）

**测试**:
- 分配超过初始堆大小的内存
- 验证堆自动扩展
- 检查内存统计准确性

## 阶段7: 完整统计和诊断
**目标**: 实现所有统计功能
**实现**:
- 实现 `rust_memory_stats()`
- 实现 `rust_memory_summary()`
- 实现 `rust_memory_check()`
- 实现内存泄漏检测

**测试**:
- 查询各种统计信息
- 故意制造内存泄漏并检测
- 验证统计数据准确

---

## 当前状态: 准备阶段1

下一步: 实现阶段1 - 最小可用FFI

